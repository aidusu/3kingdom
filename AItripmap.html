<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=visualization"></script>
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
  <style>
    #map { height: 60vh; width: 100%; }
    .form-group { margin: 10px 0; }
  </style>
</head>
<body>
  <div class="form-group">
    <input type="text" id="teamId" placeholder="團隊編號" required>
    <input type="text" id="name" placeholder="姓名" required>
    <button onclick="submitLocation()">提交位置</button>
    <button onclick="verifyTeam()">確認團隊</button>
  </div>
  <div id="map"></div>
  <div id="status"></div>

  <script>
    let map;
    let markerCluster;
    const deviceId = localStorage.getItem('deviceId') || uuid.v4();

    // 初始化地圖
    function initMap(center = {lat: 25.0330, lng: 121.5654}) {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: center,
        mapTypeId: 'roadmap'
      });
    }

    // 提交位置資料
    async function submitLocation() {
      const position = await getCurrentPosition();
      const data = {
        teamId: document.getElementById('teamId').value,
        name: document.getElementById('name').value,
        uuid: deviceId,
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        time: new Date().toISOString()
      };

      try {
        const response = await fetch('你的Google Apps Script URL', {
          method: 'POST',
          body: JSON.stringify(data)
        });
        showStatus('位置更新成功', 'green');
      } catch (error) {
        showStatus('提交失敗', 'red');
      }
    }

    // 驗證團隊並顯示地圖
    async function verifyTeam() {
      try {
        const response = await fetch(`你的Google Apps Script URL?teamId=${document.getElementById('teamId').value}&name=${document.getElementById('name').value}&uuid=${deviceId}`);
        const { status, locations } = await response.json();
        
        if(status === 'success') {
          if(markerCluster) markerCluster.clearMarkers();
          const markers = locations.map(loc => new google.maps.Marker({
            position: {lat: loc.lat, lng: loc.lng},
            title: `${loc.name} (${new Date(loc.time).toLocaleString()})`
          }));
          
          markerCluster = new markerClusterer.MarkerClusterer({map, markers});
          map.setCenter(markers[0].getPosition());
        } else {
          showStatus('驗證失敗：無效的團隊資訊', 'red');
        }
      } catch (error) {
        showStatus('伺服器錯誤', 'red');
      }
    }

    // 獲取當前位置
    function getCurrentPosition() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject('Geolocation not supported');
          return;
        }

        navigator.geolocation.getCurrentPosition(
          position => resolve(position),
          error => reject(error),
          {enableHighAccuracy: true, timeout: 5000}
        );
      });
    }

    // 狀態顯示
    function showStatus(message, color) {
      const statusDiv = document.getElementById('status');
      statusDiv.style.color = color;
      statusDiv.textContent = message;
    }

    // 初始化
    localStorage.setItem('deviceId', deviceId);
    initMap();
  </script>
</body>
</html>
